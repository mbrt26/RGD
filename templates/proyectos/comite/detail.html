{% extends "base.html" %}
{% load static %}
{% load project_filters %}

{% block title %}{{ comite.nombre }}{% endblock %}

{% block extra_css %}
<style>
    .header-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .stats-mini {
        background: rgba(255,255,255,0.1);
        border-radius: 0.5rem;
        padding: 0.75rem;
        text-align: center;
    }
    .proyecto-row {
        transition: all 0.2s;
        border-left: 4px solid transparent;
    }
    .proyecto-row.estado-verde { border-left-color: #28a745; }
    .proyecto-row.estado-amarillo { border-left-color: #ffc107; }
    .proyecto-row.estado-rojo { border-left-color: #dc3545; }
    .proyecto-row.estado-azul { border-left-color: #007bff; }
    
    .estado-badge {
        font-size: 0.8rem;
        padding: 0.35rem 0.65rem;
        border-radius: 0.5rem;
    }
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .table th {
        white-space: nowrap;
        font-size: 0.85rem;
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .table td {
        font-size: 0.85rem;
        vertical-align: middle;
    }
    .timeline-item {
        position: relative;
        padding-left: 2rem;
        padding-bottom: 1rem;
    }
    .timeline-item:before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0.5rem;
        bottom: -1rem;
        width: 2px;
        background: #dee2e6;
    }
    .timeline-item:last-child:before {
        display: none;
    }
    .timeline-marker {
        position: absolute;
        left: 0;
        top: 0.5rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: #007bff;
        border: 2px solid white;
        box-shadow: 0 0 0 2px #dee2e6;
    }
    .participante-card {
        transition: transform 0.2s;
        border-bottom: 1px solid #dee2e6;
        padding: 1rem;
    }
    .participante-card:hover {
        background-color: #f8f9fa;
    }
    .participante-card:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
<!-- Token CSRF para JavaScript -->
{% csrf_token %}

<!-- Header del comité -->
<div class="card header-card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-1">
                    <i class="fas fa-users-cog me-2"></i>{{ comite.nombre }}
                </h2>
                <p class="mb-0 opacity-75">
                    <i class="fas fa-calendar-alt me-2"></i>{{ comite.fecha_comite|date:"l, d 'de' F 'de' Y - H:i" }}
                    {% if comite.lugar %} | <i class="fas fa-map-marker-alt me-2"></i>{{ comite.lugar }}{% endif %}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="row g-2">
                    <div class="col-4">
                        <div class="stats-mini">
                            <div class="h4 mb-0">{{ estadisticas_comite.total_proyectos }}</div>
                            <small>Proyectos</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stats-mini">
                            <div class="h4 mb-0">{{ estadisticas_comite.participantes_confirmados }}</div>
                            <small>Confirmados</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stats-mini">
                            <div class="h4 mb-0">{{ estadisticas_comite.avance_promedio }}%</div>
                            <small>Avance Prom.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Barra de acciones -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{% url 'proyectos:comite_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver
        </a>
    </div>
    <div class="btn-group">
        <a href="{% url 'proyectos:comite_update' comite.pk %}" class="btn btn-outline-primary">
            <i class="fas fa-edit me-2"></i>Editar
        </a>
        {% if comite.estado == 'programado' %}
        <button class="btn btn-success" onclick="iniciarComite()">
            <i class="fas fa-play me-2"></i>Iniciar Comité
        </button>
        {% elif comite.estado == 'en_curso' %}
        <button class="btn btn-warning" onclick="finalizarComite()">
            <i class="fas fa-stop me-2"></i>Finalizar
        </button>
        {% endif %}
        <button class="btn btn-outline-primary" onclick="exportarProyectos()">
            <i class="fas fa-download me-2"></i>Exportar
        </button>
        <a href="{% url 'proyectos:comite_acta' comite.pk %}" class="btn btn-outline-secondary" target="_blank">
            <i class="fas fa-print me-2"></i>Acta
        </a>
    </div>
</div>

<!-- Tabs de navegación -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="seguimiento-tab" data-bs-toggle="tab" data-bs-target="#seguimiento" type="button" role="tab">
            <i class="fas fa-project-diagram me-2"></i>Seguimiento de Proyectos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
            <i class="fas fa-info-circle me-2"></i>Información General
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="participantes-tab" data-bs-toggle="tab" data-bs-target="#participantes" type="button" role="tab">
            <i class="fas fa-users me-2"></i>Participantes <span class="badge bg-secondary">{{ participantes.count }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">
            <i class="fas fa-history me-2"></i>Historial
        </button>
    </li>
</ul>

<!-- Contenido de los tabs -->
<div class="tab-content">
    <!-- Tab de Seguimiento -->
    <div class="tab-pane fade show active" id="seguimiento" role="tabpanel">
        <!-- Navegación rápida -->
        <div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
            <div>
                <i class="fas fa-info-circle me-2"></i>
                <strong>Secciones disponibles:</strong> Proyectos/Servicios en seguimiento y Elementos externos
            </div>
            <a href="#elementos-externos" class="btn btn-sm btn-warning">
                <i class="fas fa-external-link-alt me-1"></i>Ir a Elementos Externos
            </a>
        </div>
        
        <!-- Resumen de estados -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body" style="background: rgba(40, 167, 69, 0.1);">
                        <div class="h3 text-success mb-1">{{ estadisticas_comite.proyectos_normales }}</div>
                        <div class="small text-success">
                            <i class="fas fa-check-circle me-1"></i>Sin problemas
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body" style="background: rgba(255, 193, 7, 0.1);">
                        <div class="h3 text-warning mb-1">{{ estadisticas_comite.proyectos_atencion }}</div>
                        <div class="small text-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>Requieren atención
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body" style="background: rgba(220, 53, 69, 0.1);">
                        <div class="h3 text-danger mb-1">{{ estadisticas_comite.proyectos_criticos }}</div>
                        <div class="small text-danger">
                            <i class="fas fa-exclamation-circle me-1"></i>Críticos
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body" style="background: rgba(0, 123, 255, 0.1);">
                        <div class="h3 text-info mb-1">
                            {{ estadisticas_comite.total_proyectos|add:"-0"|add:estadisticas_comite.proyectos_normales|add:estadisticas_comite.proyectos_atencion|add:estadisticas_comite.proyectos_criticos }}
                        </div>
                        <div class="small text-info">
                            <i class="fas fa-pause-circle me-1"></i>En pausa
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de seguimiento -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Seguimiento de Proyectos y Servicios
                </h5>
            </div>
            <div class="card-body p-0">
                {% if seguimientos or seguimientos_servicios or servicios_activos %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 3%;">#</th>
                                <th style="width: 15%;">Cliente</th>
                                <th style="width: 10%;">Centro de Costos</th>
                                <th style="width: 25%;">Proyecto/Servicio</th>
                                <th style="width: 8%;">Tipo</th>
                                <th style="width: 8%;">Estado</th>
                                <th style="width: 15%;">Responsable</th>
                                <th style="width: 16%;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Seguimientos de proyectos -->
                            {% for seguimiento in seguimientos %}
                            <tr class="proyecto-row estado-{{ seguimiento.estado_seguimiento }}">
                                <td class="text-center">
                                    <span class="badge bg-light text-dark">{{ seguimiento.orden_presentacion }}</span>
                                </td>
                                <td>{{ seguimiento.proyecto.cliente }}</td>
                                <td>
                                    <span class="badge bg-info text-white">{{ seguimiento.proyecto.centro_costos }}</span>
                                </td>
                                <td>
                                    <div>
                                        <a href="{% url 'proyectos:proyecto_detail' seguimiento.proyecto.pk %}" 
                                           class="text-decoration-none fw-bold">
                                            {{ seguimiento.proyecto.nombre_proyecto }}
                                        </a>
                                        <div class="small text-muted">
                                            <i class="fas fa-chart-line me-1"></i>
                                            Avance: {{ seguimiento.avance_reportado }}%
                                            {% if seguimiento.variacion_avance %}
                                                <span class="{% if seguimiento.variacion_avance > 0 %}text-success{% elif seguimiento.variacion_avance < 0 %}text-danger{% else %}text-muted{% endif %}">
                                                    ({% if seguimiento.variacion_avance > 0 %}+{% endif %}{{ seguimiento.variacion_avance }}%)
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary">
                                        <i class="fas fa-project-diagram me-1"></i>Proyecto
                                    </span>
                                </td>
                                <td>
                                    <span class="badge estado-badge"
                                          style="background-color: {{ seguimiento.color_seguimiento }}; color: white;">
                                        <i class="{{ seguimiento.icono_seguimiento }} me-1"></i>
                                        {{ seguimiento.get_estado_seguimiento_display|slice:":1" }}
                                    </span>
                                </td>
                                <td>
                                    {% if seguimiento.responsable_reporte %}
                                        {{ seguimiento.responsable_reporte.nombre }}
                                    {% else %}
                                        <span class="text-muted">Sin asignar</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'proyectos:seguimiento_update' seguimiento.pk %}" 
                                           class="btn btn-outline-primary" 
                                           title="Editar seguimiento">
                                            <i class="fas fa-edit"></i> Editar
                                        </a>
                                        <button type="button" 
                                                class="btn btn-outline-danger" 
                                                onclick="confirmarEliminacionSeguimiento('{% url 'proyectos:seguimiento_delete' seguimiento.pk %}', 'proyecto', '{{ seguimiento.proyecto.nombre_proyecto|escapejs }}')"
                                                title="Eliminar seguimiento">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            
                            <!-- Seguimientos de servicios -->
                            {% for seguimiento_servicio in seguimientos_servicios %}
                            <tr class="proyecto-row estado-{{ seguimiento_servicio.estado_seguimiento }}">
                                <td class="text-center">
                                    <span class="badge bg-light text-dark">S{{ seguimiento_servicio.orden_presentacion }}</span>
                                </td>
                                <td>{{ seguimiento_servicio.servicio.cliente_crm.nombre }}</td>
                                <td>
                                    <span class="badge bg-info text-white">{{ seguimiento_servicio.servicio.centro_costo|default:"Sin CC" }}</span>
                                </td>
                                <td>
                                    <div>
                                        {% if seguimiento_servicio.servicio.trato_origen and seguimiento_servicio.servicio.trato_origen.descripcion %}
                                        <a href="{% url 'servicios:solicitud_detail' seguimiento_servicio.servicio.pk %}" 
                                           class="text-decoration-none fw-bold">
                                            {{ seguimiento_servicio.servicio.trato_origen.descripcion|truncatewords:20 }}
                                        </a>
                                        <div class="small text-muted">
                                            <i class="fas fa-file-invoice me-1"></i>
                                            {{ seguimiento_servicio.servicio.numero_orden }}
                                        </div>
                                        {% else %}
                                        <a href="{% url 'servicios:solicitud_detail' seguimiento_servicio.servicio.pk %}" 
                                           class="text-decoration-none fw-bold">
                                            {{ seguimiento_servicio.servicio.numero_orden }}
                                        </a>
                                        {% endif %}
                                        <div class="small text-muted">
                                            <i class="fas fa-chart-line me-1"></i>
                                            Avance: {{ seguimiento_servicio.avance_reportado }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-success">
                                        <i class="fas fa-tools me-1"></i>Servicio
                                    </span>
                                </td>
                                <td>
                                    <span class="badge estado-badge"
                                          style="background-color: {{ seguimiento_servicio.color_seguimiento }}; color: white;">
                                        <i class="{{ seguimiento_servicio.icono_seguimiento }} me-1"></i>
                                        {{ seguimiento_servicio.get_estado_seguimiento_display|slice:":1" }}
                                    </span>
                                </td>
                                <td>
                                    {% if seguimiento_servicio.responsable_reporte %}
                                        {{ seguimiento_servicio.responsable_reporte.nombre }}
                                    {% else %}
                                        <span class="text-muted">Sin asignar</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'proyectos:seguimiento_servicio_update' seguimiento_servicio.pk %}" 
                                           class="btn btn-outline-primary" 
                                           title="Editar seguimiento">
                                            <i class="fas fa-edit"></i> Editar
                                        </a>
                                        <button type="button" 
                                                class="btn btn-outline-danger" 
                                                onclick="confirmarEliminacionSeguimiento('{% url 'proyectos:seguimiento_servicio_delete' seguimiento_servicio.pk %}', 'servicio', '{{ seguimiento_servicio.servicio.numero_orden|escapejs }}')"
                                                title="Eliminar seguimiento">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            
                            <!-- Servicios activos sin seguimiento -->
                            {% for servicio in servicios_activos %}
                            <tr class="proyecto-row {% if servicio.estado == 'atrasado' %}estado-rojo{% elif servicio.estado == 'en_ejecucion' %}estado-amarillo{% else %}estado-verde{% endif %}">
                                <td class="text-center">
                                    <span class="badge bg-light text-dark">S{{ forloop.counter|add:seguimientos_servicios.count }}</span>
                                </td>
                                <td>{{ servicio.cliente_crm.nombre }}</td>
                                <td>
                                    <span class="badge bg-info text-white">{{ servicio.centro_costo|default:"Sin CC" }}</span>
                                </td>
                                <td>
                                    <div>
                                        {% if servicio.trato_origen and servicio.trato_origen.descripcion %}
                                        <a href="{% url 'servicios:solicitud_detail' servicio.pk %}" 
                                           class="text-decoration-none fw-bold">
                                            {{ servicio.trato_origen.descripcion|truncatewords:20 }}
                                        </a>
                                        <div class="small text-muted">
                                            <i class="fas fa-file-invoice me-1"></i>
                                            {{ servicio.numero_orden }}
                                        </div>
                                        {% else %}
                                        <a href="{% url 'servicios:solicitud_detail' servicio.pk %}" 
                                           class="text-decoration-none fw-bold">
                                            {{ servicio.numero_orden }}
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-success">
                                        <i class="fas fa-tools me-1"></i>Servicio
                                    </span>
                                </td>
                                <td>
                                    <span class="badge estado-badge {% if servicio.estado == 'pendiente' %}bg-secondary{% elif servicio.estado == 'en_ejecucion' %}bg-warning text-dark{% elif servicio.estado == 'atrasado' %}bg-danger{% else %}bg-success{% endif %}">
                                        <i class="fas fa-{% if servicio.estado == 'pendiente' %}clock{% elif servicio.estado == 'en_ejecucion' %}play{% elif servicio.estado == 'atrasado' %}exclamation-triangle{% else %}check{% endif %} me-1"></i>
                                        {{ servicio.get_estado_display|slice:":8" }}
                                    </span>
                                </td>
                                <td>
                                    {% if servicio.tecnico_asignado %}
                                        {{ servicio.tecnico_asignado.nombre_completo }}
                                    {% else %}
                                        <span class="text-muted">Sin asignar</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'servicios:solicitud_detail' servicio.pk %}" 
                                           class="btn btn-outline-info" 
                                           title="Ver servicio">
                                            <i class="fas fa-eye"></i> Ver
                                        </a>
                                        <button class="btn btn-outline-success" 
                                                title="Agregar seguimiento"
                                                onclick="agregarSeguimientoServicio({{ servicio.pk }})">
                                            <i class="fas fa-plus"></i> Seguimiento
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-project-diagram text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">No hay proyectos ni servicios en seguimiento</h5>
                    <p class="text-muted">Los proyectos y servicios activos se agregan automáticamente al crear el comité</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Separador visual -->
        <hr class="my-4">
        
        <!-- Elementos externos -->
        <div class="card mt-4 border-warning" id="elementos-externos">
            <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-warning">
                    <i class="fas fa-external-link-alt me-2"></i>Elementos Externos
                </h5>
                <a href="{% url 'proyectos:elemento_externo_create' comite.pk %}" 
                   class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-plus me-1"></i>Agregar Elemento
                </a>
            </div>
            <div class="card-body p-0">
                {% if elementos_externos %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Cliente</th>
                                <th>Centro Costos</th>
                                <th>Nombre</th>
                                <th>Estado</th>
                                <th>Responsable</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for elemento in elementos_externos %}
                            <tr>
                                <td>
                                    <span class="badge {% if elemento.tipo_elemento == 'proyecto' %}bg-primary{% else %}bg-success{% endif %}">
                                        {{ elemento.get_tipo_elemento_display }}
                                    </span>
                                </td>
                                <td>{{ elemento.cliente }}</td>
                                <td>{{ elemento.centro_costos|default:"-" }}</td>
                                <td>{{ elemento.nombre_proyecto }}</td>
                                <td>
                                    <span class="badge estado-badge" style="background-color: {{ elemento.color_seguimiento }}; color: white;">
                                        {{ elemento.get_estado_seguimiento_display|slice:":1" }}
                                    </span>
                                </td>
                                <td>{{ elemento.responsable_reporte.nombre|default:"Sin asignar" }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'proyectos:elemento_externo_update' elemento.pk %}" 
                                           class="btn btn-outline-primary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'proyectos:elemento_externo_delete' elemento.pk %}" 
                                           class="btn btn-outline-danger">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-external-link-alt text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2 mb-3">No hay elementos externos registrados</p>
                    <a href="{% url 'proyectos:elemento_externo_create' comite.pk %}" 
                       class="btn btn-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>Agregar Elemento Externo
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tab de Información General -->
    <div class="tab-pane fade" id="info" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Detalles del Comité</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Estado:</strong></td>
                                <td>
                                    <span class="badge {% if comite.estado == 'programado' %}bg-info{% elif comite.estado == 'en_curso' %}bg-warning text-dark{% elif comite.estado == 'finalizado' %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ comite.get_estado_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Coordinador:</strong></td>
                                <td>{{ comite.coordinador.nombre|default:"Sin asignar" }}</td>
                            </tr>
                            <tr>
                                <td><strong>Tipo:</strong></td>
                                <td>{{ comite.get_tipo_comite_display }}</td>
                            </tr>
                            <tr>
                                <td><strong>Duración estimada:</strong></td>
                                <td>{{ comite.duracion_estimada }} minutos</td>
                            </tr>
                            <tr>
                                <td><strong>Creado por:</strong></td>
                                <td>{{ comite.creado_por.get_full_name|default:comite.creado_por.username|default:"Sistema" }}</td>
                            </tr>
                            <tr>
                                <td><strong>Fecha creación:</strong></td>
                                <td>{{ comite.fecha_creacion|date:"d/m/Y H:i" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                {% if comite.agenda %}
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Agenda</h6>
                    </div>
                    <div class="card-body">
                        <div class="p-3 bg-light rounded">
                            {{ comite.agenda|linebreaks }}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if comite.observaciones %}
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">Observaciones</h6>
                    </div>
                    <div class="card-body">
                        {{ comite.observaciones|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tab de Participantes -->
    <div class="tab-pane fade" id="participantes" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Participantes del Comité
                </h5>
                <a href="{% url 'proyectos:gestionar_participantes_comite' comite.pk %}" 
                   class="btn btn-sm btn-primary">
                    <i class="fas fa-user-plus me-2"></i>Gestionar Participantes
                </a>
            </div>
            <div class="card-body">
                {% if participantes %}
                <div class="row">
                    {% for participante in participantes %}
                    <div class="col-md-6">
                        <div class="participante-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-bold">{{ participante.colaborador.nombre }}</div>
                                    <div class="text-muted small">{{ participante.colaborador.cargo }}</div>
                                    {% if participante.rol_en_comite %}
                                    <div class="text-info small">{{ participante.rol_en_comite }}</div>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <span class="badge {% if participante.estado_asistencia == 'confirmado' %}bg-success{% elif participante.estado_asistencia == 'presente' %}bg-primary{% elif participante.estado_asistencia == 'ausente' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                        {{ participante.get_estado_asistencia_display }}
                                    </span>
                                    <div class="small text-muted mt-1">
                                        {{ participante.get_tipo_participacion_display }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-user-slash text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">Sin participantes registrados</h5>
                    <a href="{% url 'proyectos:gestionar_participantes_comite' comite.pk %}" 
                       class="btn btn-primary mt-3">
                        <i class="fas fa-user-plus me-2"></i>Agregar Participantes
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tab de Historial -->
    <div class="tab-pane fade" id="historial" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Historial del Comité
                </h5>
            </div>
            <div class="card-body">
                <div class="timeline-item">
                    <div class="timeline-marker bg-primary"></div>
                    <div>
                        <div class="fw-bold">Comité creado</div>
                        <div class="text-muted small">{{ comite.fecha_creacion|date:"d/m/Y H:i" }}</div>
                        {% if comite.creado_por %}
                        <div class="text-muted small">por {{ comite.creado_por.get_full_name|default:comite.creado_por.username }}</div>
                        {% endif %}
                    </div>
                </div>
                {% if comite.fecha_actualizacion != comite.fecha_creacion %}
                <div class="timeline-item">
                    <div class="timeline-marker bg-info"></div>
                    <div>
                        <div class="fw-bold">Última actualización</div>
                        <div class="text-muted small">{{ comite.fecha_actualizacion|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
                {% endif %}
                {% if comite.estado == 'en_curso' %}
                <div class="timeline-item">
                    <div class="timeline-marker bg-warning"></div>
                    <div>
                        <div class="fw-bold">Comité en curso</div>
                        <div class="text-muted small">El comité está actualmente en progreso</div>
                    </div>
                </div>
                {% elif comite.estado == 'finalizado' %}
                <div class="timeline-item">
                    <div class="timeline-marker bg-success"></div>
                    <div>
                        <div class="fw-bold">Comité finalizado</div>
                        <div class="text-muted small">El comité ha sido completado</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Función helper para obtener el token CSRF
function getCSRFToken() {
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken && csrfToken.value) {
        return csrfToken.value;
    }
    return null;
}

// Función para agregar seguimiento a servicio
function agregarSeguimientoServicio(servicioId) {
    const csrfToken = getCSRFToken();
    if (!csrfToken) {
        alert('Error: No se pudo obtener el token CSRF');
        return;
    }

    if (confirm('¿Desea agregar este servicio al seguimiento del comité?')) {
        fetch(`{% url 'proyectos:agregar_servicio_seguimiento' comite.pk %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                servicio_id: servicioId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Servicio agregado al seguimiento exitosamente');
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'No se pudo agregar el servicio'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al agregar el servicio al seguimiento');
        });
    }
}

// Función para iniciar comité
function iniciarComite() {
    if (confirm('¿Está seguro de iniciar el comité?')) {
        // Implementar lógica
        alert('Función en desarrollo');
    }
}

// Función para finalizar comité
function finalizarComite() {
    if (confirm('¿Está seguro de finalizar el comité?')) {
        // Implementar lógica
        alert('Función en desarrollo');
    }
}

// Función para exportar proyectos
function exportarProyectos() {
    window.location.href = "{% url 'proyectos:comite_export' comite.pk %}";
}

function confirmarEliminacionSeguimiento(url, tipo, nombre) {
    const tipoTexto = tipo === 'proyecto' ? 'proyecto' : 'servicio';
    const mensaje = `¿Está seguro de que desea eliminar el seguimiento del ${tipoTexto} "${nombre}" de este comité?\n\nEsta acción no se puede deshacer.`;
    
    if (confirm(mensaje)) {
        // Crear un formulario para hacer POST con CSRF token
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = url;
        
        // Agregar CSRF token
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = getCSRFToken();
        form.appendChild(csrfToken);
        
        // Agregar el formulario al body y enviarlo
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}